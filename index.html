<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Sample Viewer - OK/NG + Detail</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: sans-serif;
      padding: 1rem;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 1rem;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }

    th {
      background-color: #f0f0f0;
    }

    tr.ok {
      background-color: #d4edda;
    }

    tr.ng {
      background-color: #f8d7da;
    }

    .subtable td {
      background-color: #f9f9f9;
      font-size: 0.9em;
    }

    .clickable {
      cursor: pointer;
    }

    .element-flag {
      font-weight: bold;
    }

    .element-flag[data-flag=">"], .element-flag[data-flag="<"] {
      color: red;
    }
  </style>
</head>
<body>
  <h2>Latest Samples with OK/NG Status</h2>
  <table id="dataTable">
    <thead>
      <tr>
        <th>Time</th>
        <th>Grade</th>
        <th>Method</th>
        <th>Runs Done</th>
        <th>Total Elements</th>
        <th>NG Count</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const supabaseUrl = "https://yjrwvozuyidjfyjfqqnu.supabase.co";
    const anonKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlqcnd2b3p1eWlkamZ5amZxcW51Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI0MjIwMjgsImV4cCI6MjA2Nzk5ODAyOH0.u5t_yWbYINBKldTl-0dMjo006zTxExfx8kvKmntrkNE";
    const tableBody = document.querySelector("#dataTable tbody");

    async function loadData() {
      try {
        const resHeader = await fetch(`${supabaseUrl}/rest/v1/result_header?order=created_at.desc&limit=10`, {
          headers: {
            apikey: anonKey,
            Authorization: `Bearer ${anonKey}`
          }
        });

        const headersData = await resHeader.json();
        tableBody.innerHTML = "";

        for (const header of headersData) {
          const resultId = header.id;

          const resElements = await fetch(`${supabaseUrl}/rest/v1/result_element?result_id=eq.${resultId}`, {
            headers: {
              apikey: anonKey,
              Authorization: `Bearer ${anonKey}`
            }
          });

          const elements = await resElements.json();
          const total = elements.length;
          const ngCount = elements.filter(el => el.element_flag === ">" || el.element_flag === "<").length;
          const status = ngCount > 0 ? "NG" : "OK";
          const rowClass = ngCount > 0 ? "ng" : "ok";

          // Main row
          const row = document.createElement("tr");
          row.className = `${rowClass} clickable`;
          row.innerHTML = `
            <td>${header.time ?? "-"}</td>
            <td>${header.grade ?? "-"}</td>
            <td>${header.analytical_method ?? "-"}</td>
            <td>${header.runs_done ?? "-"}</td>
            <td>${total}</td>
            <td>${ngCount}</td>
            <td><strong>${status}</strong></td>
          `;

          // Detail row (hidden initially)
          const detailRow = document.createElement("tr");
          const detailCell = document.createElement("td");
          detailCell.colSpan = 7;

          const elementTable = document.createElement("table");
          elementTable.classList.add("subtable");
          elementTable.innerHTML = `
            <thead>
              <tr><th>Element</th><th>Value</th><th>Flag</th></tr>
            </thead>
            <tbody>
              ${elements.map(el => `
                <tr>
                  <td>${el.element_name}</td>
                  <td>${el.element_value}</td>
                  <td class="element-flag" data-flag="${el.element_flag}">${el.element_flag || "OK"}</td>
                </tr>
              `).join("")}
            </tbody>
          `;

          detailCell.appendChild(elementTable);
          detailRow.appendChild(detailCell);
          detailRow.style.display = "none";

          // Toggle detail on click
          row.addEventListener("click", () => {
            detailRow.style.display = detailRow.style.display === "none" ? "table-row" : "none";
          });

          tableBody.appendChild(row);
          tableBody.appendChild(detailRow);
        }

      } catch (err) {
        console.error("Fetch error:", err);
        tableBody.innerHTML = `<tr><td colspan="7">Error: ${err.message}</td></tr>`;
      }
    }

    loadData();
  </script>
</body>
</html>
