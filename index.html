<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Dashboard Sampel Analisis</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f1f5f9;
    }

    .detail-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .detail-content.expanded {
      max-height: 1000px;
    }
  </style>
</head>
<body class="bg-slate-100">

  <div class="container mx-auto p-4 sm:p-6 lg:p-8">
    <div class="bg-white rounded-xl shadow-lg overflow-hidden border border-slate-200">
      <div class="p-6 flex justify-between items-center bg-slate-50 border-b border-slate-200">
        <div>
            <h2 class="text-xl sm:text-2xl font-bold text-slate-800">Laporan Sampel Terbaru</h2>
            <p class="text-slate-500 mt-1 text-sm">Menampilkan 10 hasil terakhir. Klik baris untuk detail.</p>
        </div>
        <div>
            <button id="refreshBtn" title="Muat Ulang Data" class="p-2 rounded-full text-slate-500 hover:bg-slate-200 hover:text-slate-700 active:bg-slate-300 transition-colors duration-200">
                <svg id="refreshIcon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h5M2.46 15a9 9 0 113.99-12.55L8 9"/>
                </svg>
            </button>
        </div>
      </div>

      <div class="overflow-x-auto">
        <table id="dataTable" class="min-w-full text-sm">
          <thead class="bg-slate-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Waktu</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Grade</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Metode</th>
              <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 uppercase tracking-wider">Runs</th>
              <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 uppercase tracking-wider">Elemen</th>
              <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 uppercase tracking-wider">NG</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Status</th>
              <th class="px-6 py-3"></th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-slate-200"></tbody>
        </table>
      </div>
    </div>
    <footer class="text-center mt-8 text-sm text-slate-500">
      <p>Dashboard Analisis Sampel</p>
    </footer>
  </div>

  <script>
    const supabaseUrl = "https://yjrwvozuyidjfyjfqqnu.supabase.co";
    const anonKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlqcnd2b3p1eWlkamZ5amZxcW51Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI0MjIwMjgsImV4cCI6MjA2Nzk5ODAyOH0.u5t_yWbYINBKldTl-0dMjo006zTxExfx8kvKmntrkNE";

    const tableBody = document.querySelector("#dataTable tbody");
    const refreshBtn = document.querySelector("#refreshBtn");
    const refreshIcon = document.querySelector("#refreshIcon");

    function formatFromHeader(day, month, year, time) {
      const fullDate = `20${year}-${month}-${day}T${time}`;
      const d = new Date(fullDate);
      if (isNaN(d.getTime())) return `${day}/${month}/${year} ${time}`;
      return d.toLocaleString("id-ID", {
        day: "2-digit", month: "short", year: "numeric",
        hour: "2-digit", minute: "2-digit", second: "2-digit"
      });
    }

    async function loadData() {
      refreshIcon.classList.add('animate-spin');
      tableBody.innerHTML = `
        <tr>
          <td colspan="8" class="text-center p-10 text-slate-500">Memuat data...</td>
        </tr>
      `;

      try {
        const resHeader = await fetch(`${supabaseUrl}/rest/v1/result_header?order=created_at.desc&limit=10`, {
          headers: { apikey: anonKey, Authorization: `Bearer ${anonKey}` }
        });

        const headersData = await resHeader.json();
        tableBody.innerHTML = "";

        if (headersData.length === 0) {
          tableBody.innerHTML = `<tr><td colspan="8" class="text-center p-10 text-slate-500">Tidak ada data.</td></tr>`;
          return;
        }

        for (const header of headersData) {
          const resultId = header.id;
          const resElements = await fetch(`${supabaseUrl}/rest/v1/result_element?result_id=eq.${resultId}`, {
            headers: { apikey: anonKey, Authorization: `Bearer ${anonKey}` }
          });
          const elements = await resElements.json();

          const total = elements.length;
          const ngCount = elements.filter(el => el.element_flag === ">" || el.element_flag === "<").length;
          const status = ngCount > 0 ? "NG" : "OK";

          const waktu = formatFromHeader(header.day, header.month, header.year, header.time);
          const badgeClass = status === "OK" ? "bg-green-100 text-green-800" : "bg-red-100 text-red-800";
          const rowHover = status === "OK" ? "hover:bg-green-50/50" : "hover:bg-red-50/50";

          const row = document.createElement("tr");
          row.className = `cursor-pointer transition-colors duration-200 ${rowHover}`;
          row.innerHTML = `
            <td class="px-6 py-4 text-slate-600">${waktu}</td>
            <td class="px-6 py-4 font-semibold text-slate-800">${header.grade}</td>
            <td class="px-6 py-4 text-slate-600">${header.analytical_method}</td>
            <td class="px-6 py-4 text-center text-slate-600">${header.runs_done}</td>
            <td class="px-6 py-4 text-center text-slate-600">${total}</td>
            <td class="px-6 py-4 text-center font-bold ${ngCount > 0 ? 'text-red-600' : 'text-slate-700'}">${ngCount}</td>
            <td class="px-6 py-4">
              <span class="px-3 py-1 inline-flex text-xs font-semibold rounded-full ${badgeClass}">
                ${status}
              </span>
            </td>
            <td class="px-6 py-4 text-right">
              <svg class="h-5 w-5 text-slate-400 transition-transform duration-300 chevron-icon" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
              </svg>
            </td>
          `;

          const detailRow = document.createElement("tr");
          const detailCell = document.createElement("td");
          detailCell.colSpan = 8;
          detailCell.className = "p-0";

          const detailContent = document.createElement("div");
          detailContent.className = "detail-content";

          const inner = document.createElement("div");
          inner.className = "p-5 bg-slate-50";

          const elementTable = document.createElement("table");
          elementTable.className = "min-w-full text-xs";
          elementTable.innerHTML = `
            <thead class="bg-slate-200">
              <tr><th class="py-2 px-4">Elemen</th><th class="py-2 px-4">Nilai</th><th class="py-2 px-4">Flag</th></tr>
            </thead>
            <tbody>
              ${elements.map(el => `
                <tr class="border-b hover:bg-slate-100">
                  <td class="py-2 px-4">${el.element_name}</td>
                  <td class="py-2 px-4">${el.element_value}</td>
                  <td class="py-2 px-4 font-bold ${el.element_flag === ">" || el.element_flag === "<" ? "text-red-600" : "text-green-600"}">${el.element_flag || "OK"}</td>
                </tr>`).join("")}
            </tbody>
          `;

          inner.appendChild(elementTable);
          detailContent.appendChild(inner);
          detailCell.appendChild(detailContent);
          detailRow.appendChild(detailCell);

          row.addEventListener("click", () => {
            const icon = row.querySelector('.chevron-icon');
            detailContent.classList.toggle("expanded");
            icon.classList.toggle("rotate-180");
          });

          tableBody.appendChild(row);
          tableBody.appendChild(detailRow);
        }
      } catch (e) {
        console.error(e);
        tableBody.innerHTML = `<tr><td colspan="8" class="text-center text-red-600">Error: ${e.message}</td></tr>`;
      } finally {
        refreshIcon.classList.remove('animate-spin');
      }
    }

    refreshBtn.addEventListener("click", loadData);
    loadData();
  </script>
</body>
</html>
